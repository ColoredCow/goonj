name: staging-deployment
on:
  push:
    branches: dev

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: SSH and deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          SSH_BUILD_DIRECTORY: ${{ secrets.SSH_BUILD_DIRECTORY }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: SSH_BUILD_DIRECTORY
          script_stop: true
          script: |
            set -eu
            (set -o pipefail) 2>/dev/null && set -o pipefail

            cd "$SSH_BUILD_DIRECTORY"

            # Keep repo in sync with origin/dev (requires correct server-side permissions).
            rm -f .git/index.lock 2>/dev/null || true
            git fetch --prune origin dev
            git reset --hard origin/dev

